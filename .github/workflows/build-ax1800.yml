name: Build Xiaomi AX1800 Firmware

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/build-ax1800.yml"
      - "target/linux/qualcommax/**"
      - "package/firmware/ath11k-firmware/**"
      - "include/target.mk"

permissions:
  contents: read

concurrency:
  group: build-ax1800-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 4096
          swap-size-mb: 2048
          remove-dotnet: true
          remove-android: true
          remove-haskell: true
          remove-codeql: true

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libncurses5-dev gawk git subversion libssl-dev \
            gettext zlib1g-dev swig unzip time rsync python3 python3-pip \
            file wget ccache

      - name: Update and install feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Generate .config for Xiaomi AX1800
        run: |
          cat > .config <<'EOF'
          CONFIG_DEVEL=y
          CONFIG_BPF_TOOLCHAIN_HOST=y
          CONFIG_TARGET_qualcommax=y
          CONFIG_TARGET_qualcommax_ipq60xx=y
          CONFIG_TARGET_qualcommax_ipq60xx_DEVICE_xiaomi_ax1800=y
          EOF
          make defconfig

      - name: Download sources
        run: make download -j"$(nproc)"

      - name: Build firmware
        run: |
          make -j"$(nproc)" BUILD_LOG=1 || make -j1 V=s BUILD_LOG=1

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: build-logs-ax1800
          path: logs/
          if-no-files-found: ignore

      - name: Collect firmware artifacts
        run: |
          mkdir -p artifacts
          cp -a bin/targets/qualcommax/ipq60xx artifacts/
          (cd artifacts && sha256sum ipq60xx/* > SHA256SUMS)

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xiaomi-ax1800-firmware
          path: artifacts/
          if-no-files-found: error
